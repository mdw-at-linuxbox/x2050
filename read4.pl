# read in data.bin (or the like), containing
# 90-bit microcode lines, and print out a "data.json" style of it.

use common::sense;
my $headup = "{\n";
my $address_format = '    "%04x": {'."\n";
my $separator = <<'.';
    },
.
my $endsep = <<'.';
    }
}
.
my $endup = "";

my $has_extra_data = {
 "0004" => 1, "0006" => 1, "000a" => 1, "000e" => 1, "0012" => 1, "0016"
 => 1, "001a" => 1, "001e" => 1, "0022" => 1, "0026" => 1, "002a" => 1,
 "0031" => 1, "0032" => 1, "0033" => 1, "0037" => 1, "003b" => 1, "003c"
 => 1, "003e" => 1, "003f" => 1, "004c" => 1, "004e" => 1, "00bc" => 1,
 "00c9" => 1, "00ca" => 1, "00cb" => 1, "00d5" => 1, "0100" => 1, "0101"
 => 1, "0103" => 1, "0104" => 1, "0105" => 1, "0108" => 1, "0109" => 1,
 "010c" => 1, "010d" => 1, "010e" => 1, "010f" => 1, "0110" => 1, "0111"
 => 1, "0112" => 1, "0113" => 1, "0114" => 1, "0115" => 1, "0116" => 1,
 "0117" => 1, "011a" => 1, "011b" => 1, "011e" => 1, "011f" => 1, "0122"
 => 1, "0123" => 1, "012e" => 1, "012f" => 1, "0132" => 1, "0136" => 1,
 "0137" => 1, "0138" => 1, "0139" => 1, "013a" => 1, "013b" => 1, "013d"
 => 1, "013e" => 1, "013f" => 1, "0141" => 1, "0143" => 1, "0144" => 1,
 "0145" => 1, "0146" => 1, "0147" => 1, "0148" => 1, "0149" => 1, "014a"
 => 1, "014b" => 1, "014c" => 1, "014d" => 1, "014e" => 1, "014f" => 1,
 "0156" => 1, "0182" => 1, "0184" => 1, "0185" => 1, "0186" => 1, "0187"
 => 1, "0188" => 1, "0189" => 1, "018a" => 1, "018e" => 1, "0195" => 1,
 "0197" => 1, "0198" => 1, "0199" => 1, "019b" => 1, "019d" => 1, "019f"
 => 1, "01a0" => 1, "01a9" => 1, "01ab" => 1, "01ad" => 1, "01ae" => 1,
 "01af" => 1, "01b2" => 1, "01b6" => 1, "01b9" => 1, "01ba" => 1, "01bb"
 => 1, "01bc" => 1, "01bd" => 1, "01be" => 1, "01bf" => 1, "01c1" => 1,
 "01c3" => 1, "01d0" => 1, "01d1" => 1, "01d2" => 1, "01d3" => 1, "01d4"
 => 1, "01d5" => 1, "01d6" => 1, "01d7" => 1, "0230" => 1, "0285" => 1,
 "0289" => 1, "028d" => 1, "02c5" => 1, "0300" => 1, "0301" => 1, "0303"
 => 1, "0304" => 1, "0305" => 1, "0306" => 1, "0307" => 1, "0308" => 1,
 "0309" => 1, "030a" => 1, "030b" => 1, "030c" => 1, "030d" => 1, "030e"
 => 1, "030f" => 1, "0310" => 1, "0311" => 1, "0312" => 1, "0313" => 1,
 "0314" => 1, "0315" => 1, "0316" => 1, "0317" => 1, "0318" => 1, "0319"
 => 1, "031a" => 1, "031b" => 1, "031c" => 1, "031d" => 1, "031e" => 1,
 "031f" => 1, "0321" => 1, "0323" => 1, "0324" => 1, "0325" => 1, "0326"
 => 1, "0327" => 1, "0328" => 1, "0329" => 1, "032a" => 1, "032b" => 1,
 "032c" => 1, "032d" => 1, "032e" => 1, "032f" => 1, "0331" => 1, "0333"
 => 1, "0335" => 1, "0336" => 1, "0337" => 1, "0338" => 1, "0339" => 1,
 "033a" => 1, "033b" => 1, "033c" => 1, "033d" => 1, "033e" => 1, "033f"
 => 1, "0340" => 1, "0341" => 1, "0342" => 1, "0344" => 1, "0348" => 1,
 "034a" => 1, "034b" => 1, "034d" => 1, "0351" => 1, "0352" => 1, "0354"
 => 1, "0355" => 1, "0380" => 1, "0390" => 1, "0391" => 1, "0392" => 1,
 "0393" => 1, "0394" => 1, "0395" => 1, "0397" => 1, "0398" => 1, "0399"
 => 1, "039a" => 1, "039b" => 1, "03a5" => 1, "03a6" => 1, "03a7" => 1,
 "03a8" => 1, "03ab" => 1, "03ac" => 1, "03ad" => 1, "03b4" => 1, "03b6"
 => 1, "03b7" => 1, "03ba" => 1, "03c4" => 1, "03c5" => 1, "03c6" => 1,
 "03c7" => 1, "03c8" => 1, "03c9" => 1, "03ca" => 1, "03cb" => 1, "03cc"
 => 1, "03cd" => 1, "03ce" => 1, "03cf" => 1, "03d0" => 1, "03d1" => 1,
 "03d2" => 1, "03d3" => 1, "03d4" => 1, "03d5" => 1, "03d6" => 1, "03d7"
 => 1, "0401" => 1, "0405" => 1, "0406" => 1, "0409" => 1, "0418" => 1,
 "041d" => 1, "0421" => 1, "0422" => 1, "0424" => 1, "0426" => 1, "042c"
 => 1, "043a" => 1, "043d" => 1, "043e" => 1, "044d" => 1, "0450" => 1,
 "0451" => 1, "0452" => 1, "0454" => 1, "0456" => 1, "048e" => 1, "048f"
 => 1, "0491" => 1, "0493" => 1, "0494" => 1, "0496" => 1, "0499" => 1,
 "049b" => 1, "049c" => 1, "049e" => 1, "04a0" => 1, "04a1" => 1, "04a2"
 => 1, "04a3" => 1, "04a4" => 1, "04a6" => 1, "04a8" => 1, "04a9" => 1,
 "04aa" => 1, "04ab" => 1, "04ac" => 1, "04ae" => 1, "04b2" => 1, "04b3"
 => 1, "04b4" => 1, "04b5" => 1, "04b6" => 1, "04b7" => 1, "04b8" => 1,
 "04ba" => 1, "04c3" => 1, "04c8" => 1, "04ca" => 1, "04cc" => 1, "04cf"
 => 1, "04d1" => 1, "04d2" => 1, "04d3" => 1, "04d4" => 1, "04d5" => 1,
 "04d7" => 1, "0500" => 1, "0501" => 1, "0502" => 1, "0504" => 1, "0505"
 => 1, "0506" => 1, "0508" => 1, "050d" => 1, "050f" => 1, "0515" => 1,
 "0516" => 1, "0517" => 1, "0518" => 1, "0519" => 1, "051b" => 1, "0526"
 => 1, "0528" => 1, "0529" => 1, "052b" => 1, "052d" => 1, "052f" => 1,
 "0531" => 1, "0533" => 1, "0535" => 1, "0536" => 1, "0537" => 1, "0538"
 => 1, "0539" => 1, "053a" => 1, "053c" => 1, "053d" => 1, "053e" => 1,
 "0544" => 1, "0557" => 1, "0581" => 1, "0583" => 1, "0584" => 1, "0588"
 => 1, "058b" => 1, "058c" => 1, "0592" => 1, "05a4" => 1, "05a5" => 1,
 "05a6" => 1, "05a7" => 1, "05a8" => 1, "05ab" => 1, "05ac" => 1, "05ad"
 => 1, "05af" => 1, "05b1" => 1, "05b2" => 1, "05b3" => 1, "05b7" => 1,
 "05bb" => 1, "05c6" => 1, "05ca" => 1, "05cb" => 1, "05cd" => 1, "05d1"
 => 1, "05d2" => 1, "05d3" => 1, "05d4" => 1, "05d5" => 1, "05d6" => 1,
 "05d7" => 1, "0600" => 1, "0605" => 1, "0607" => 1, "0616" => 1, "0617"
 => 1, "0620" => 1, "0624" => 1, "0628" => 1, "062c" => 1, "06c6" => 1,
 "06d1" => 1, "0706" => 1, "0707" => 1, "070d" => 1, "070f" => 1, "0712"
 => 1, "0716" => 1, "0734" => 1, "0737" => 1, "0739" => 1, "073b" => 1,
 "073d" => 1, "074f" => 1, "0754" => 1, "0755" => 1, "0757" => 1, "07a8"
 => 1, "07bc" => 1, "07bd" => 1, "07be" => 1, "07bf" => 1, "07c0" => 1,
 "07c1" => 1, "07c2" => 1, "07c3" => 1, "07c4" => 1, "07c5" => 1, "07c6"
 => 1, "07c7" => 1, "07c8" => 1, "07c9" => 1, "07ca" => 1, "07cb" => 1,
 "07cc" => 1, "07cd" => 1, "07ce" => 1, "07cf" => 1, "07d0" => 1, "07d1"
 => 1, "07d2" => 1, "07d3" => 1, "07d4" => 1, "07d5" => 1, "07d6" => 1,
 "07d7" => 1, "0800" => 1, "0801" => 1, "0803" => 1, "0804" => 1, "0805"
 => 1, "0806" => 1, "0807" => 1, "0808" => 1, "0809" => 1, "080a" => 1,
 "080b" => 1, "080c" => 1, "080d" => 1, "080f" => 1, "0810" => 1, "0811"
 => 1, "0812" => 1, "0813" => 1, "0814" => 1, "0815" => 1, "0816" => 1,
 "0817" => 1, "0818" => 1, "0819" => 1, "081a" => 1, "081b" => 1, "082e"
 => 1, "0830" => 1, "0831" => 1, "0832" => 1, "0833" => 1, "0834" => 1,
 "0835" => 1, "083d" => 1, "0844" => 1, "0852" => 1, "0854" => 1, "0855"
 => 1, "0856" => 1, "0857" => 1, "08cf" => 1, "08d6" => 1, "08d7" => 1,
 "0909" => 1, "090f" => 1, "0910" => 1, "0913" => 1, "0926" => 1, "092a"
 => 1, "092e" => 1, "093d" => 1, "0942" => 1, "0944" => 1, "0946" => 1,
 "0949" => 1, "094a" => 1, "0955" => 1, "0956" => 1, "0957" => 1, "0999"
 => 1, "099b" => 1, "09a7" => 1, "09a8" => 1, "09aa" => 1, "09ab" => 1,
 "09c1" => 1, "09c2" => 1, "09c3" => 1, "09c4" => 1, "09c5" => 1, "09c6"
 => 1, "09c7" => 1, "09c8" => 1, "09c9" => 1, "09ca" => 1, "09cb" => 1,
 "09cc" => 1, "09cd" => 1, "09ce" => 1, "09cf" => 1, "09d0" => 1, "09d1"
 => 1, "09d2" => 1, "09d3" => 1, "09d4" => 1, "09d5" => 1, "09d6" => 1,
 "09d7" => 1, "0a00" => 1, "0a02" => 1, "0a03" => 1, "0a04" => 1, "0a05"
 => 1, "0a06" => 1, "0a07" => 1, "0a10" => 1, "0a11" => 1, "0a13" => 1,
 "0a22" => 1, "0a23" => 1, "0a34" => 1, "0a44" => 1, "0a45" => 1, "0a46"
 => 1, "0a47" => 1, "0a49" => 1, "0a4b" => 1, "0a50" => 1, "0a52" => 1,
 "0a53" => 1, "0a84" => 1, "0a85" => 1, "0a86" => 1, "0a87" => 1, "0a90"
 => 1, "0a92" => 1, "0a93" => 1, "0a96" => 1, "0a97" => 1, "0a98" => 1,
 "0a99" => 1, "0a9a" => 1, "0a9b" => 1, "0a9e" => 1, "0a9f" => 1, "0aa0"
 => 1, "0aa1" => 1, "0aa2" => 1, "0aa3" => 1, "0ab0" => 1, "0ab2" => 1,
 "0ab3" => 1, "0ab6" => 1, "0ac9" => 1, "0aca" => 1, "0acb" => 1, "0acc"
 => 1, "0acd" => 1, "0ace" => 1, "0acf" => 1, "0ad2" => 1, "0b04" => 1,
 "0b05" => 1, "0b06" => 1, "0b07" => 1, "0b30" => 1, "0b4b" => 1, "0ba5"
 => 1, "0bb0" => 1, "0c00" => 1, "0c10" => 1, "0c14" => 1, "0c18" => 1,
 "0c1a" => 1, "0c1b" => 1, "0c1c" => 1, "0c20" => 1, "0c32" => 1, "0c33"
 => 1, "0c35" => 1, "0c38" => 1, "0c39" => 1, "0c3c" => 1, "0c3d" => 1,
 "0c3e" => 1, "0c3f" => 1, "0c46" => 1, "0c47" => 1, "0c4a" => 1, "0c4c"
 => 1, "0c52" => 1, "0c53" => 1, "0c8a" => 1, "0c91" => 1, "0cac" => 1,
 "0cad" => 1, "0caf" => 1, "0cb4" => 1, "0cb5" => 1, "0cb6" => 1, "0cb7"
 => 1, "0cb9" => 1, "0cba" => 1, "0cbb" => 1, "0cce" => 1, "0cd0" => 1,
 "0cd1" => 1, "0cd2" => 1, "0cd3" => 1, "0cd5" => 1, "0cd6" => 1, "0cd7"
 => 1, "0d25" => 1, "0d27" => 1, "0d39" => 1, "0d3a" => 1, "0d3b" => 1,
 "0d8a" => 1, "0d8b" => 1, "0d91" => 1, "0d93" => 1, "0d96" => 1, "0d97"
 => 1, "0db0" => 1, "0db1" => 1, "0db3" => 1, "0db9" => 1, "0dba" => 1,
 "0dbb" => 1, "0dbc" => 1, "0dbd" => 1, "0dbe" => 1, "0dbf" => 1, "0dc0"
 => 1, "0dc1" => 1, "0dc3" => 1, "0dc5" => 1, "0dc6" => 1, "0dc7" => 1,
 "0dc8" => 1, "0dc9" => 1, "0dca" => 1, "0dcb" => 1, "0dcc" => 1, "0dcd"
 => 1, "0dce" => 1, "0dcf" => 1, "0dd0" => 1, "0dd1" => 1, "0dd2" => 1,
 "0dd3" => 1, "0dd4" => 1, "0dd5" => 1, "0dd6" => 1, "0dd7" => 1, "0e06"
 => 1, "0e07" => 1, "0e08" => 1, "0e09" => 1, "0e0a" => 1, "0e0b" => 1,
 "0e0d" => 1, "0e0e" => 1, "0e0f" => 1, "0e10" => 1, "0e11" => 1, "0e12"
 => 1, "0e13" => 1, "0e2e" => 1, "0e34" => 1, "0e3f" => 1, "0e41" => 1,
 "0e43" => 1, "0e55" => 1, "0e88" => 1, "0e8a" => 1, "0e93" => 1, "0e98"
 => 1, "0e99" => 1, "0e9a" => 1, "0e9b" => 1, "0ea2" => 1, "0ec8" => 1,
 "0eca" => 1, "0ecc" => 1, "0ecd" => 1, "0ece" => 1, "0ecf" => 1, "0ed2"
 => 1, "0ed3" => 1, "0ed4" => 1, "0ed5" => 1, "0ed6" => 1, "0ed7" => 1,
 "0f13" => 1, "0f14" => 1, "0f1c" => 1, "0f1e" => 1, "0f2c" => 1, "0f2d"
 => 1, "0f31" => 1, "0f39" => 1, "0f3e" => 1, "0f53" => 1, "0f54" => 1,
 "0f9a" => 1, "0fab" => 1, "0fac" => 1 };

my $io_format = [
{"P" => 56}, {"LU" => [1,3]}, {"MV" => [4,5]},
{"ZP" => [6,11]}, {"ZF" => [12,15]},
{"ZN" => [16,18]}, {"TR" => [19,23]},
{"ZR" => 24},
{"CS" => 25}, {"SA" => [26,27]},
{"SF" => [28,30]},

{"CT" => [32,34]}, {"AL" => [35,39]},
{"WL" => [40,42]},
{"HC" => 43},
{"MS" => [44,46]},
{"CG" => [47,48]},
{"MG" => [49,51]}, {"UL" => [52,53]},
{"UR" => [54,55]},

{"CE" => [57,60]},
{"LX" => [61,63]},
{"TC" => 64},
{"RY" => [65,67]},
{"CL" => [68,70]},
{"?" => 71},
{"AB" => [72,77]},
{"BB" => [78,82]},
{"UX" => 83},
{"SS" => [84,89]},
];

my $cpu_format = [
{"P" => 56}, {"LU" => [1,3]}, {"MV" => [4,5]},
{"ZP" => [6,11]}, {"ZF" => [12,15]},
{"ZN" => [16,18]}, {"TR" => [19,23]},
{"ZR" => 24},
{"WS" => [25,27]}, {"SF" => [28,30]},

{"IV" => [32,34]}, {"AL" => [35,39]},
{"WM" => [40,43]}, {"UP" => [44,45]},
{"MD" => 46},
{"LB" => 47},
{"MB" => 48},
{"DG" => [49,51]}, {"UL" => [52,53]},
{"UR" => [54,55]},

{"CE" => [57,60]},
{"LX" => [61,63]},
{"TC" => 64},
{"RY" => [65,67]},
{"AD" => [68,71]}, {"AB" => [72,77]},
{"BB" => [78,82]},
{"UX" => 83},
{"SS" => [84,89]},
];

my $data_format = [
{"P" => 56},
{"B0" => [1,30]},
{"B1" => [32,55]},
{"B2" => [57,89]},
];

sub write_the_data
{
	my ($format, $data) = @_;
	for my $e ( @$format) {
		my @kk = keys %$e;
		if ($#kk != 0) {
			die "help!\n";
		}
		my $k = $kk[0];
		my $b = $e->{$k};
		my $d;
		if (ref $b eq 'ARRAY') {
			my $dd = substr($data, $$b[0], 1+$$b[1]-$$b[0]);
			$d = 0;
			for my $c ( split(//, $dd)) {
				$d <<= 1;
				$d |= 1 if ($c == 1);
			}
		} else {
			$d = substr($data, $b, 1);
		}
		printf qq/        "%s": %d,\n/, $k, $d;
	}
}

while (<>) {
	next if /^#/;
	chomp;
	if (!m%@([^ ]+)  *([0-9a-fA-F_]*)(?:|  *// (.*))$%) {
		print STDERR "can't parse <$_>\n";
		next;
	}
	my $addr = substr($_, $-[1], $+[1]-$-[1]);
	my $data = substr($_, $-[2], $+[2]-$-[2]);
	my ($sheet, $cld);
	if (defined($-[3])) {
		my @s = split(" ", substr($_, $-[3], $+[3]-$-[3]));
		($sheet, $cld) = @s;
	}
	$addr = hex($addr);
	my $format;
	if ($data =~ /^._..._.._......_...._..._....._._._.._..._._..._....._..._._..._.._..._.._.._._...._..._._..._..._._......_....._._......$/) {
		$format = $io_format;
	} elsif ($data =~ /^._..._.._......_...._..._....._._..._..._._..._....._...._.._._._._..._.._.._._...._..._._..._...._......_....._._......$/) {
		$format = $cpu_format;
	} else {
		$format = $data_format;
	}
	$data =~ s%_%%g;
	print $headup;
	printf $address_format, $addr;
	$headup = $separator;
	$endup = $endsep;
	write_the_data($format, $data);
	if ($has_extra_data->{sprintf "%04x", $addr}) {
		printf qq/        "?1": 0,\n/, $data;
		printf qq/        "?2": 0,\n/, $data;
	}
	printf qq/        "ROS": "%s"/, $data;
	if (defined($sheet)) {
		printf qq/,\n        "sheet": "%s"/, $sheet;
	}
	print "\n";
}
print $endup;
